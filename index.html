<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Car-Lite</title>

    <style>
        :root {
            --color-gray-900: #242429;
            --color-gray-500: #454549;
            --color-gray-100: #ABABAD;

            --color-aa-bg: #16171B;


            --color-text-100: #fff;
            --color-interactive-100: #64D2FF;

            --color-admin-tertiary: #001A33;

            --radius-1x: .5rem;
            --radius-2x: .75rem;
        }

        html {
            box-sizing: border-box;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            margin: 0;
            background-color: var(--color-admin-tertiary);
            color: var(--color-text-100);
            font-family: sans-serif;
        }
        
        a {
            color: var(--color-interactive-100);
        }

        h2:empty {display: none;}

        img { width: 100%; }

        #audio {
            width: 100%;
            position: fixed;
            bottom: 0;
            z-index: 1000;
        }

        /* ================= */
        /*       Params      */
        /* ================= */
        #params {
            text-align: center;
            /*  Temp remove - need to consider alternate layout
            overflow: scroll;
            white-space: nowrap;
            */
        }

        #params ul {
            display: inline-block;
            margin-right: 3rem;
            padding: 0;
            list-style: none;
        }

        #params li {
            display: inline;
            margin-right: 1rem;
        }

        #params a {
            display: inline-block;
            line-height: 1.5rem;
            padding: .25rem .75rem;
            border-radius: 4px;
            border: 1px solid transparent;
            text-decoration: none;
            color: var(--color-text-100);
            opacity: .6;
        }

        #params a:hover, #params a:focus {
            color: var(--color-interactive-100);
            opacity: 1;
            border-color: rgba(255,255,255,.13);
            background-color: rgba(255,255,255,.03);
        }

        #params .current a {
            opacity: 1;
            color: var(--color-text-100);
            background-color: rgba(255,255,255,.1);
            border-color: rgba(255,255,255,.13);
        }
        /* === End of Params ===== */

        .car-screen{
            padding: 1rem;
            border-radius: 2rem 2rem 0 0;
            background-color: var(--color-gray-900);
        }
        .car-screen:has(.AndroidAuto) {
            background-color: var(--color-aa-bg);
        }

        #car { 
            clear: both;
            padding-bottom: 3rem; 
        }

        .car-back { 
            float: left;
            margin: 1rem 3rem 3rem 0;
            height: 1.5rem;
        }

        #features { float: left; }

        #features ul {
            display: flex;
            margin: 1rem 0 3rem 0;
            padding: 0;
            list-style: none;
            font-size: 1.25rem;
            line-height: 1.75rem;
        }

        #features li { margin-right: 2rem; }

        #features a { text-decoration: none; }
        #features a:hover { text-decoration: underline; }



        /* ================= */
        /*     List Item     */
        /* ================= */
        .car_list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .car_list li {
            display: block;
            background-color: var(--color-gray-500);
            margin-bottom: .5rem;
            border-radius: var(--radius-2x);
        }
        .AndroidAuto .car_list li {
            background-color: transparent;
            border-radius: 0px;
            border-bottom: 1px solid rgba(255,255,255,.2);
            margin-bottom: 0;
            padding: .25rem 0;
        }

        .car_list a {
            display: flex;
            flex-direction: column;
            min-height: 7rem;
            padding: .75rem;
            text-decoration: none;
        }

        .car_list img {
            position: absolute;
            width: 5.5rem;
            border-radius: var(--radius-1x);
        }

        .car_list p {
            padding-left: 6.25rem;
            margin: 0;
        }

        .car_list p:first-of-type {
            color: var(--color-text-100);
            font-size: 1.875rem;
            line-height: 1;
            margin: .75rem 0 .625rem 0;
        }

        .car_list p:last-of-type {
            color: var(--color-gray-100);
            font-size: 1.5rem;
            line-height: 1;
        }

        .car_list a:hover p:first-of-type { color: var(--color-interactive-100); }

        /* === End of List Item ===== */

        /* ================= */
        /*        Grid       */
        /* ================= */

        div:has(> .car_grid) {
            position: relative;
            padding: .5rem 1.5rem 1.5rem 1.5rem;
            margin: 0 0 .5rem 0;
            border-radius: var(--radius-2x);
            background-color: var(--color-gray-500);
        }
        .AndroidAuto div:has(> .car_grid) {
            background-color: transparent;
            border-radius: 0px;
            border-bottom: 1px solid rgba(255,255,255,.2);
            margin-bottom: 0;
            padding: .75rem 0;
        }

        .more_link:has(~ .car_grid) {
            position: absolute;
            top: .5rem;
            right: 1.5rem;
            line-height: 4rem;
            text-decoration: none;
        } 

        .more_link:has(~ .car_grid):hover { text-decoration: underline; }

        .car_grid {
            display: flex;
            flex-wrap: nowrap;
            overflow: hidden;
            list-style: none;
            padding: 0;
            margin: 0 -1rem;
        }

        .car_grid li {
            width: calc(100%/6);
            min-width: 8rem;
            max-width: 15rem;
            padding: 0 1rem;
        }

        .AndroidAuto .car_grid li {
            width: calc(100%/3);
            max-width: 24rem;
        }
        .AndroidAuto .car_grid li:nth-child(n+4) { display: none; }

        .car_grid li a {
            line-height: 1.3;
            text-decoration: none;
            color: var(--color-text-100)
        }
        .car_grid li a:hover {color: var(--color-interactive-100)}
        .car_grid li img { margin: 0 0 .5rem 0; border-radius: var(--radius-2x);}
        .car_grid li p { margin: 0 0 .25rem 0; }
        .CarPlay .car_grid li p { display: none; }
        .AndroidAuto .car_grid li p:last-of-type { display: none; }
    </style>
</head>
<body>
    <div id="params"></div>
    <audio id="audio" controls></audio>
    <div class="car-screen">
        <button onclick="history.back()" class="car-back">Back</button>
        <div id="features"></div>
        <div id="car"></div>
    </div>
<script type="module">

const hasIterationProtocol = variable => variable !== null && Symbol.iterator in Object(variable)
function h(type, params, children) {
    const el = document.createElement(type)
    for (let [k,v] of Object.entries(params)) {el.setAttribute(k,v)}
    if      (["string","number"].indexOf(typeof(children))>=0) {el.appendChild(document.createTextNode(children))}
    else if (hasIterationProtocol(children)) {for (let c of children) {el.append(c)}}
    else if (children                      ) {el.appendChild(children)}
    return el
}

// Params ----------------------------------------------------------------------

const ENDPOINTS = {
    dev: "https://bff-car-guacamole.dev.digital.global.com",
    staging: "https://bff-car-guacamole.stg.diginf.musicradio.com",
    prod: "https://bff-car-guacamole.musicradio.com",
}
const VERSIONS = [1,2,3,4,5,6]
const PLATFORMS = ["CarPlay", "AndroidAuto", "json"]
const APP_VARIANT = ["GP", "LBC"]

const DEFAULT_PARAMS = {
    endpoint: ENDPOINTS.prod,  //window.location.origin
    vnd_version: VERSIONS.at(-1),
    platform: PLATFORMS.at(0),
    app_variant: APP_VARIANT.at(0),
    path: '/features/home-hub',
    play_universal_id: '',
}


// State Management ------------------------------------------------------------

class State {
    constructor(defaults) {
        this.defaults = defaults
        this._session = {
            ...this.defaults.session,
        }
    }

    new_hash(partial_hash) {
        const params = {...this.hash, ...partial_hash}
        for (let [k, v] of Object.entries(this.defaults.hash)) {if (params[k] == v) {delete params[k]}}
        return `#${new URLSearchParams(params).toString()}`
    }
    get hash() {
        return {
            ...this.defaults.hash,
            ...Object.fromEntries(new URLSearchParams(window.location.hash.replace('#',''))),
        }
    }
    set hash(data) {
        throw new Error('not implemented')
    }

    get session() {
        return this._session
    }
    set session(data) {
        throw new Error('not implemented')
    }
    get persistent() {
        return null
    }
}

const state = new State({hash: DEFAULT_PARAMS, session: {previous_payload: null}})


function hrefPath(path) {return state.new_hash({'path': path})}


// Params UI -------------------------------------------------------------------

function render_params(hash) {
    function render_params_links(param, items) {
        return h('ul', {}, items.map(([name, value])=>
            h('li',{class: value==hash[param]?'current':''},
                h('a',{href: state.new_hash({[param]: value})}, name)
            )
        ))
    }
    const element = document.getElementById("params")
    element.innerHTML = "";
    element.append(...[
        render_params_links('endpoint'   , Object.entries(ENDPOINTS)),
        render_params_links('vnd_version', VERSIONS.map(v=>[`v${v}`, v])),
        render_params_links('platform'   , PLATFORMS.map(p=>[p, p])),
        //render_params_links('app_variant', APP_VARIANT.map(a=>[a, a])),
    ])
}

// Request ---------------------------------------------------------------------

async function bff_get(path) {
    const hash = state.hash

    if (state.session.incredibleBulk && state.session.incredibleBulk[path]) {
        console.log(`incredibleBulk ${path}`)
        return state.session.incredibleBulk[path]
    }

    const carHeaders = new Headers()
    carHeaders.append("Accept", `application/vnd.global.${hash.vnd_version}+json`)
    //carHeaders.append("App-Variant", params.app_variant)  // TODO: Adding any headers prevents CORS extension from working.
    const authorization = hash.authorization || ''
    if (authorization) {carHeaders.append("Authorization", authorization)}

    console.log('get', path)
    return await (await fetch(`${hash.endpoint}${path}`, {headers: carHeaders})).json()
}

// Renderers -------------------------------------------------------------------

function render_action(primary_action) {
    const primary_action_link = primary_action.payload?.link?.href
    const primary_action_id = primary_action.payload?.id
    if (primary_action_link) {return hrefPath(primary_action_link)}
    if (primary_action_id) {return state.new_hash({'play_universal_id': primary_action_id})}
    throw Error(`unknown primary_action ${primary_action}`)
}
function render_item(car_item) {
    return h('li',{},
        h('a',
            {href: render_action(car_item.primary_action)},
            [
                h('img',{src: state?.session?.incredibleBulkImages?.[car_item.image.url] || car_item.image.url}),
                h('p',{},car_item.title),
                h('p',{},car_item.subtitle),
            ])
    )
}
function render_grid(car_items) {
    return h('ul',{class: 'car_grid'}, car_items.map(render_item))
}
function render_list(car_items) {
    return h('ul',{class: 'car_list'}, car_items.map(render_item))
}
function render_continue_listening() {
    return 'continue_listening'
}
function render_placeholder() {
    return 'placeholder'
}
function render_more_link(content) {
    if (content.type == 'grid') {
        return h('a',{href: hrefPath(content.primary_action.payload?.link?.href), class:`more_link`}, 'More')
    }
    return ''
}
function render_page(car_response) {
    return h('div',{class: state.hash.platform},[
        h('h1',{},car_response.title),
        h('div',{},car_response.sections.map(section=>section.content.map(content=>h('div',{},[
            h('h2',{},content.title),
            render_more_link(content),
            {
                grid: render_grid,
                list: render_list,
                continue_listening: render_continue_listening,
                placeholder: render_placeholder,
            }[content.type](content.items),
        ])
        )).flat())
    ])
}
function render_json(car_response) {
    const hash = state.hash
    return h('div',{},[
        h('pre',{class: 'curl'},`curl --compressed --location-trusted --header "Accept: application/vnd.global.${hash.vnd_version}+json" --header "App-Variant: ${hash.app_variant}" --request GET --url ${hash.endpoint}${hash.path}`),
        h('pre',{class: 'json'},JSON.stringify(car_response, null, 2)),
    ])

}

const element_car = document.getElementById('car')
function render_previous_payload() {
    element_car.innerHTML = ""
    if (!state.session.previous_payload) {return}
    const render_func = state.hash.platform=="json" ? render_json : render_page
    element_car.appendChild(render_func(state.session.previous_payload))

}


// Features/Tabs ---

function render_tabs(features_response) {
    return h('ul',{},features_response.map((feature)=>
        h('li',{},
            h('a',{
                href: feature.slug ? hrefPath(`/features/${feature.slug}`):hrefPath(feature.path),  // v1-v5 relative, v6 absolute,
                should_send_auth: feature.should_send_auth,  // TODO: currently unused
            }, feature.name)
        )
    ))
}
const element_features = document.getElementById('features')
async function update_features() {
    element_features.innerHTML = ""
    element_features.appendChild(render_tabs(await bff_get(state.hash.vnd_version<6?'/features':'/tabs')))
}


// Play ------------------------------------------------------------------------

async function play(universal_id) {
    const playable = await (await fetch(`https://bff-mobile-guacamole.musicradio.com/v16/playables/${universal_id}`)).json()
    const stream_url = playable.payload.stream_url
    if (stream_url) {const audio = document.getElementById('audio'); audio.src = stream_url; audio.play();}
    else            {console.error('unable to find stream_url in', playable)}
}

// Main ------------------------------------------------------------------------

let previous_hash = state.hash
previous_hash.path = 'ensure first run always has a changed path'  // TODO: tidy this
previous_hash.vnd_version = 'ensure first run always has a changed version'
let hashchange_timestamp;    // Debounce: browsers double fire this event? Bad browser!
window.addEventListener('hashchange', async (event)=>{
    if ((new Date()).getTime() - hashchange_timestamp < 10) {return}  // replace with debounce?
    hashchange_timestamp = (new Date()).getTime()

    const hash = state.hash
    const changedKeys = new Set(Object.entries(hash).map(([key, value])=>value==previous_hash[key]?null:key).filter(key=>key))

    if (changedKeys.has('play_universal_id') && hash.play_universal_id) {await play(hash.play_universal_id); return}

    render_params(hash)

    if (changedKeys.has('endpoint') && hash.endpoint.endsWith('.json')) {
        console.log('endpoint is a single json file - assuming incredibleBulk')
        state.session.incredibleBulk = await (await fetch(hash.endpoint)).json()
        state.session.incredibleBulkImages = await (await fetch(hash.endpoint.replace('.json','-images.json'))).json()
    }

    // On state difference update/change
    if (changedKeys.intersection(new Set(['endpoint','platform','vnd_version'])).size) {
        await update_features()   // the tabs can change on version change
    }
    if (changedKeys.intersection(new Set(['platform',])).size) {
        render_previous_payload()  // platform is just style change and does not need fetch
    }
    if (changedKeys.intersection(new Set(['endpoint', 'vnd_version', 'app_variant', 'path'])).size) {
        state.session.previous_payload = await bff_get(hash.path)
        render_previous_payload()
    }

    previous_hash = hash
})
window.dispatchEvent(new HashChangeEvent("hashchange"))
</script>
</body>
</html>
